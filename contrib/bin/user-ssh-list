#!/bin/bash

CLUSTO="clusto-query"

usage() {
        if [ "$0" == "root-ssh-list" ]; then
            echo "Usage: $0 clusto_query command_to_run" >&2
        elif [ "$0" == "user-ssh-list" ]; then
            echo "Usage: $0 username clusto_query command_to_run" >&2
        fi
	exit 1
}

username="$1"
if [ -z "$username" ]; then
	usage
fi
shift

query="$1"
if [ -z "$query" ]; then
	usage
fi
shift
if [ -z "$*" ] ; then
	usage
fi

if [ "$query" = "all" ] ; then
    query="(clusto_type=server)"
fi
export CLUSTO_TYPE_FILTER="server"
for h in $($CLUSTO $query | sort) ; do
	ping -w1 -c1 -q $h > /dev/null 2>&1
	if [ $? -ne 0 ]; then
		continue
	fi
	if [ -n "$SSH_LIST_NO_PREFIX" ]; then
		sed_cmd=''
	else
		sed_cmd="s,^,$h | ,"
	fi
	( ssh -o ConnectTimeout=3 -o StrictHostKeyChecking=no -l $username $h -- "$@" 2>&1 ) | sed -e "$sed_cmd"
done
